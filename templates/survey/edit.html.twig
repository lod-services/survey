{% extends 'base.html.twig' %}

{% block title %}Edit Survey: {{ survey.title }} - AI-Powered Survey Branching{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    {% for message in app.flashes('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}

    {% for message in app.flashes('error') %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}

    <div class="row">
        <!-- Main Survey Editor -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">üìù {{ survey.title }}</h2>
                    <div class="btn-group">
                        <a href="{{ path('app_survey_preview', {id: survey.id}) }}" class="btn btn-outline-primary btn-sm" target="_blank">
                            <i class="fas fa-eye"></i> Preview
                        </a>
                        <a href="{{ path('app_survey_start', {id: survey.id}) }}" class="btn btn-outline-success btn-sm" target="_blank">
                            <i class="fas fa-play"></i> Test Survey
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Survey Settings Form -->
                    <form method="post" class="mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="title" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           value="{{ survey.title }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="branchingEnabled" 
                                               name="branchingEnabled" {{ survey.branchingEnabled ? 'checked' : '' }}>
                                        <label class="form-check-label" for="branchingEnabled">
                                            <i class="fas fa-sitemap text-success"></i> Enable AI Branching
                                        </label>
                                    </div>
                                    <small class="text-muted">Allow dynamic question flow based on responses</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2">{{ survey.description }}</textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </form>

                    <hr>

                    <!-- Questions Section -->
                    <div id="questions-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>‚ùì Questions ({{ stats.questionCount }})</h4>
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                                <i class="fas fa-plus"></i> Add Question
                            </button>
                        </div>

                        <div id="questions-list" class="sortable-list">
                            {% for question in survey.questions %}
                                <div class="card mb-2" data-question-id="{{ question.id }}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="badge bg-secondary me-2">{{ question.type|upper }}</span>
                                                    {% if question.required %}<span class="badge bg-danger me-2">Required</span>{% endif %}
                                                    {% if question.ruleTarget %}<span class="badge bg-info me-2">Rule Target</span>{% endif %}
                                                    <small class="text-muted">Order: {{ question.orderIndex }}</small>
                                                </div>
                                                <div class="question-content">{{ question.content }}</div>
                                                {% if question.options %}
                                                    <div class="mt-2">
                                                        <small class="text-muted">Options:</small>
                                                        <ul class="list-unstyled ms-3">
                                                            {% for option in question.options %}
                                                                <li><small class="text-muted">‚Ä¢ {{ option }}</small></li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-outline-primary btn-sm edit-question" 
                                                        data-question-id="{{ question.id }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm delete-question" 
                                                        data-question-id="{{ question.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        {% if survey.questions is empty %}
                            <div class="text-center py-5 text-muted">
                                <i class="fas fa-question-circle fa-3x mb-3"></i>
                                <h5>No questions added yet</h5>
                                <p>Start building your survey by adding your first question</p>
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                                    <i class="fas fa-plus"></i> Add First Question
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Survey Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üìä Survey Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="h4 text-primary">{{ stats.questionCount }}</div>
                            <small class="text-muted">Questions</small>
                        </div>
                        <div class="col-6">
                            <div class="h4 text-success">{{ stats.ruleCount }}</div>
                            <small class="text-muted">Rules</small>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Branching:</span>
                        <span class="badge {{ stats.branchingEnabled ? 'bg-success' : 'bg-secondary' }}">
                            {{ stats.branchingEnabled ? 'Enabled' : 'Disabled' }}
                        </span>
                    </div>
                    {% if stats.branchingEnabled %}
                        <div class="d-flex justify-content-between mt-2">
                            <span>Can Add Rules:</span>
                            <span class="badge {{ stats.canAddRules ? 'bg-success' : 'bg-warning' }}">
                                {{ stats.canAddRules ? 'Yes' : 'Limit Reached' }}
                            </span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Rules Section -->
            {% if survey.branchingEnabled %}
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üß† Branching Rules</h5>
                        {% if stats.canAddRules %}
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                                <i class="fas fa-plus"></i> Add Rule
                            </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if stats.ruleCount == 0 %}
                            <div class="text-center text-muted">
                                <i class="fas fa-sitemap fa-2x mb-2"></i>
                                <p>No branching rules defined</p>
                                <small>Create rules to make your survey dynamic</small>
                            </div>
                        {% else %}
                            <div class="alert alert-info" role="alert">
                                <small><i class="fas fa-info-circle"></i> Rules are evaluated in priority order</small>
                            </div>
                            <!-- Rules will be loaded via JavaScript -->
                            <div id="rules-list"></div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addQuestionForm">
                    <div class="mb-3">
                        <label class="form-label">Question Type</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select question type...</option>
                            <option value="text">Text Input</option>
                            <option value="textarea">Long Text</option>
                            <option value="select">Single Choice</option>
                            <option value="checkbox">Multiple Choice</option>
                            <option value="radio">Radio Buttons</option>
                            <option value="rating">Rating Scale</option>
                            <option value="yesno">Yes/No</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea class="form-control" name="content" rows="3" required 
                                  placeholder="Enter your question..."></textarea>
                    </div>

                    <div class="mb-3" id="options-section" style="display: none;">
                        <label class="form-label">Answer Options</label>
                        <div id="options-list">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Option 1">
                                <button type="button" class="btn btn-outline-danger remove-option">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="add-option">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="required" checked>
                        <label class="form-check-label">Required question</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-question">Add Question</button>
            </div>
        </div>
    </div>
</div>

<!-- Survey Builder JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const surveyId = {{ survey.id }};
    
    // Question type change handler
    document.querySelector('select[name="type"]').addEventListener('change', function() {
        const optionsSection = document.getElementById('options-section');
        const needsOptions = ['select', 'checkbox', 'radio', 'rating'].includes(this.value);
        optionsSection.style.display = needsOptions ? 'block' : 'none';
    });

    // Add option handler
    document.getElementById('add-option').addEventListener('click', function() {
        const optionsList = document.getElementById('options-list');
        const optionCount = optionsList.children.length + 1;
        const optionHtml = `
            <div class="input-group mb-2">
                <input type="text" class="form-control" placeholder="Option ${optionCount}">
                <button type="button" class="btn btn-outline-danger remove-option">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        `;
        optionsList.insertAdjacentHTML('beforeend', optionHtml);
    });

    // Remove option handler (event delegation)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-option') || e.target.parentElement.classList.contains('remove-option')) {
            const optionGroup = e.target.closest('.input-group');
            if (document.getElementById('options-list').children.length > 1) {
                optionGroup.remove();
            }
        }
    });

    // Save question handler
    document.getElementById('save-question').addEventListener('click', function() {
        const form = document.getElementById('addQuestionForm');
        const formData = new FormData(form);
        
        // Collect options
        const optionsInputs = document.querySelectorAll('#options-list input');
        const options = Array.from(optionsInputs)
            .map(input => input.value.trim())
            .filter(value => value !== '');
        
        if (options.length > 0) {
            formData.append('options', JSON.stringify(options));
        }

        fetch(`/surveys/${surveyId}/questions/add`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the question');
        });
    });

    // Delete question handlers
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-question') || e.target.parentElement.classList.contains('delete-question')) {
            if (confirm('Are you sure you want to delete this question?')) {
                const questionId = e.target.closest('.delete-question').dataset.questionId;
                
                fetch(`/surveys/questions/${questionId}/delete`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the question');
                });
            }
        }
    });
});
</script>
{% endblock %}